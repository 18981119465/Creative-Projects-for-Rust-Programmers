<html>
    <head>
        <title>Persons management</title>
        <script>
            /*
            Two possible messages:
            - REST api: returns data
            - request of page: returns HTML code to assign to the body
            */

            var username;
            var password;
            function sendRest(method, uri, body, success, failure) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4)
                        if (this.status == 200) success();
                        else failure();
                };
                xhttp.open(method, uri, true, username, password);
                xhttp.send(body);
            }
            function getPage(uri) {
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function() {
                    if (this.readyState == 4 && this.status == 200) {
                        document.getElementById('body')
                            .innerHTML = xhttp.responseText;
                    }
                };
                xhttp.open('GET', uri, true, username, password);
                xhttp.send(body);
            }
            function delete_selected_persons() {
                var items;
                for (var item of document.getElementsByName('selector'))
                    if (item.checked)
                        if (items) items += ',' + item.id;
                        else items = '' + item.id;
                if (items)
                    sendRest('DELETE', '/persons?id_list=' + items, '',
                        function() { getPage('/page/persons'); },
                        function() { alert('Failed deletion.'); });
            }
            function savePerson(method, body) {
                sendRest(method,
                    '/one_person?'
                    + (method === 'POST' ? '' :
                    'id='
                    + document.getElementById('person_id').value
                    + '&')
                    + 'name='
                    + encodeURIComponent(
                        document.getElementById('person_name')
                        .value),
                    body,
                    function() {
                        getPage('/page/persons');
                    },
                    function() {
                        alert('Failed command.');
                    });
                /*
                )
                + '&'
                + 'other_field=287.98')">Insert</button>
                */        
            }
        </script>
    </head>
    <body id="body" onload="getPage('/page/persons')">
    </body>
</html>
